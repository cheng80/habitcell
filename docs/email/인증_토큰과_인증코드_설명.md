# ì´ë©”ì¼ ì¸ì¦ ì½”ë“œ ì„¤ëª… (ìŠµê´€ ì•±)

ìŠµê´€ ì•± ë°±ì—…/ë³µêµ¬ ê¸°ëŠ¥ì—ì„œ ì´ë©”ì¼ ë“±ë¡ ì‹œ ì‚¬ìš©í•˜ëŠ” 6ìë¦¬ ì¸ì¦ ì½”ë“œì˜ ìƒì„±Â·ì €ì¥Â·ê²€ì¦ ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

**ëŒ€ìƒ**: Habit App (Local-first + Snapshot Backup)  
**ê°±ì‹ ì¼**: 2026-02-15

---

## ğŸ“‹ ëª©ì°¨

1. [ê°œìš”](#1-ê°œìš”)
2. [ìŠµê´€ ì•±ì—ì„œì˜ ì‚¬ìš© ë°©ì‹](#2-ìŠµê´€-ì•±ì—ì„œì˜-ì‚¬ìš©-ë°©ì‹)
3. [ì¸ì¦ ì½”ë“œ (Auth Code)](#3-ì¸ì¦-ì½”ë“œ-auth-code)
4. [ì½”ë“œ í•´ì‹œ (code_hash)](#4-ì½”ë“œ-í•´ì‹œ-code_hash)
5. [ì‚¬ìš© íë¦„](#5-ì‚¬ìš©-íë¦„)
6. [ë³´ì•ˆ ê³ ë ¤ì‚¬í•­](#6-ë³´ì•ˆ-ê³ ë ¤ì‚¬í•­)
7. [ì½”ë“œ ìœ„ì¹˜](#7-ì½”ë“œ-ìœ„ì¹˜)

---

## 1. ê°œìš”

ìŠµê´€ ì•±ì—ì„œëŠ” **ì´ë©”ì¼ì„ ë°±ì—…/ë³µêµ¬ ìˆ˜ë‹¨ìœ¼ë¡œë§Œ** ì‚¬ìš©í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ì€ ì—†ìœ¼ë©°, ì´ë©”ì¼ ë“±ë¡ ì‹œ 6ìë¦¬ ì¸ì¦ ì½”ë“œë¡œ ë³¸ì¸ í™•ì¸ì„ í•©ë‹ˆë‹¤.

- **device_uuid**: í´ë¼ì´ì–¸íŠ¸(ì•±)ê°€ ì´ë¯¸ ë³´ìœ í•œ ê¸°ê¸° ì‹ë³„ì (UUID)
- **ì¸ì¦ ì½”ë“œ**: ì´ë©”ì¼ë¡œ ë°œì†¡ë˜ì–´ ì‚¬ìš©ìê°€ ì…ë ¥í•˜ëŠ” 6ìë¦¬ ìˆ«ì
- **code_hash**: ì„œë²„ì— ì €ì¥í•  ë•Œ SHA256 í•´ì‹œë¡œ ì €ì¥ (í‰ë¬¸ ì €ì¥ ê¸ˆì§€)

---

## 2. ìŠµê´€ ì•±ì—ì„œì˜ ì‚¬ìš© ë°©ì‹

### ë‹¨ìˆœí™”ëœ íë¦„

```
1. ì´ë©”ì¼ ë“±ë¡ ìš”ì²­
   â†’ í´ë¼ì´ì–¸íŠ¸: device_uuid + email ì „ì†¡
   â†’ ì„œë²„: 6ìë¦¬ ì½”ë“œ ìƒì„± â†’ code_hash ì €ì¥ â†’ ì´ë©”ì¼ ë°œì†¡

2. ì¸ì¦ ì½”ë“œ ê²€ì¦
   â†’ ì‚¬ìš©ì: ì´ë©”ì¼ì—ì„œ ë°›ì€ 6ìë¦¬ ì½”ë“œ ì…ë ¥
   â†’ í´ë¼ì´ì–¸íŠ¸: device_uuid + email + code ì „ì†¡
   â†’ ì„œë²„: code_hash ë¹„êµ â†’ devices í…Œì´ë¸”ì— email ì—°ê²°
```

### ì‚¬ìš©ì ê´€ì 

- âœ… **ì¸ì¦ ì½”ë“œë§Œ ì…ë ¥**: ì´ë©”ì¼ë¡œ ë°›ì€ 6ìë¦¬ ìˆ«ì ì…ë ¥
- âœ… **device_uuid**: ì•±ì´ ìë™ ê´€ë¦¬ (GetStorageì— ì €ì¥)

---

## 3. ì¸ì¦ ì½”ë“œ (Auth Code)

### ì •ì˜
- **í˜•ì‹**: 6ìë¦¬ ìˆ«ì
- **ë²”ìœ„**: 100000 ~ 999999
- **ì˜ˆì‹œ**: `123456`, `789012`

### ìƒì„± ë°©ë²•
```python
import random

# 6ìë¦¬ ìˆ«ì ìƒì„± (100000 ~ 999999)
code = f"{random.randint(100000, 999999)}"
# ê²°ê³¼ ì˜ˆì‹œ: "123456"
```

### íŠ¹ì§•
- **ì‚¬ìš©ì ì¹œí™”ì **: ì§§ê³  ê¸°ì–µí•˜ê¸° ì‰¬ì›€
- **ì…ë ¥ ìš©ì´**: ìˆ«ìë§Œ ì…ë ¥
- **ì´ë©”ì¼ ë°œì†¡**: ì‚¬ìš©ì ì´ë©”ì¼ë¡œ ì§ì ‘ ì „ë‹¬
- **ë§Œë£Œ**: 10ë¶„ (expires_at)

---

## 4. ì½”ë“œ í•´ì‹œ (code_hash)

### ì •ì˜
- **í˜•ì‹**: SHA256 í•´ì‹œ (64ì 16ì§„ìˆ˜)
- **ìš©ë„**: DBì— í‰ë¬¸ ì½”ë“œë¥¼ ì €ì¥í•˜ì§€ ì•Šê¸° ìœ„í•¨

### ìƒì„± ë°©ë²•
```python
import hashlib

code = "123456"
code_hash = hashlib.sha256(code.encode()).hexdigest()
# ê²°ê³¼ ì˜ˆì‹œ: "8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92"
```

### ê²€ì¦ ë°©ë²•
```python
# ì‚¬ìš©ì ì…ë ¥ codeë¥¼ í•´ì‹œí•˜ì—¬ ì €ì¥ëœ code_hashì™€ ë¹„êµ
input_hash = hashlib.sha256(code.encode()).hexdigest()
if input_hash == stored_code_hash:
    # ì¸ì¦ ì„±ê³µ
```

### ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥
- **í…Œì´ë¸”**: `email_verifications`
- **ì»¬ëŸ¼**: `code_hash` (CHAR(64))
- **í‰ë¬¸ ì €ì¥ ê¸ˆì§€**: ë³´ì•ˆìƒ code_hashë§Œ ì €ì¥

---

## 5. ì‚¬ìš© íë¦„

### 5.1 ì´ë©”ì¼ ë“±ë¡ ìš”ì²­

```
1. ì‚¬ìš©ìê°€ ì„¤ì • > ë°±ì—…ì—ì„œ "ì´ë©”ì¼ ë“±ë¡" ìš”ì²­
   â†“
2. ì´ë©”ì¼ ì…ë ¥ í›„ "ì¸ì¦ ì½”ë“œ ë°œì†¡" í´ë¦­
   â†“
3. í´ë¼ì´ì–¸íŠ¸ API í˜¸ì¶œ
   POST /v1/recovery/email/request
   { "device_uuid": "...", "email": "user@example.com" }
   â†“
4. ì„œë²„ ì²˜ë¦¬
   - 6ìë¦¬ ì½”ë“œ ìƒì„±: random.randint(100000, 999999)
   - code_hash = sha256(code)
   - email_verificationsì— INSERT (device_uuid, email, code_hash, expires_at)
   - ì´ë©”ì¼ ë°œì†¡ (ì¸ì¦ ì½”ë“œë§Œ ì „ë‹¬)
   â†“
5. ì‚¬ìš©ìì—ê²Œ "ì´ë©”ì¼ì„ í™•ì¸í•˜ì„¸ìš”" ì•ˆë‚´
```

### 5.2 ì¸ì¦ ì½”ë“œ ê²€ì¦

```
1. ì‚¬ìš©ìê°€ ì´ë©”ì¼ì—ì„œ ë°›ì€ 6ìë¦¬ ì½”ë“œ ì…ë ¥
   â†“
2. í´ë¼ì´ì–¸íŠ¸ API í˜¸ì¶œ
   POST /v1/recovery/email/verify
   { "device_uuid": "...", "email": "user@example.com", "code": "123456" }
   â†“
3. ì„œë²„ ê²€ì¦
   - (device_uuid, email)ë¡œ email_verifications ì¡°íšŒ
   - sha256(code) == code_hash ë¹„êµ
   - expires_at í™•ì¸
   - attempt_count í™•ì¸ (5íšŒ ì œí•œ ê¶Œì¥)
   â†“
4. ì¸ì¦ ì„±ê³µ ì‹œ
   - devices í…Œì´ë¸”: email, email_verified_at ì—…ë°ì´íŠ¸
   - email_verifications ë ˆì½”ë“œ ì‚­ì œ ë˜ëŠ” ë¬´íš¨í™”
```

---

## 6. ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### 6.1 ì¸ì¦ ì½”ë“œ
- âš ï¸ **ì˜ˆì¸¡ ê°€ëŠ¥**: 6ìë¦¬ ìˆ«ì (900,000ê°œ ì¡°í•©)
- âœ… **ë§Œë£Œ ì‹œê°„**: 10ë¶„ í›„ ìë™ ë§Œë£Œ
- âœ… **ì¼íšŒìš©**: ì¸ì¦ ì„±ê³µ í›„ ë¬´íš¨í™”
- âœ… **ì‹œë„ ì œí•œ**: attempt_count 5íšŒ ì´ˆê³¼ ì‹œ ë¬´íš¨í™” ê¶Œì¥

### 6.2 code_hash ì €ì¥
- âœ… **í‰ë¬¸ ì €ì¥ ê¸ˆì§€**: DB ìœ ì¶œ ì‹œì—ë„ ì½”ë“œ ë³µì› ë¶ˆê°€
- âœ… **SHA256**: í‘œì¤€ í•´ì‹œ ì•Œê³ ë¦¬ì¦˜ ì‚¬ìš©

### 6.3 ì´ë©”ì¼ ë°œì†¡ ì œí•œ
- ë™ì¼ (device_uuid, email) ì¡°í•©ìœ¼ë¡œ 1ì‹œê°„ì— 3íšŒ ì œí•œ ê¶Œì¥

---

## 7. ì½”ë“œ ìœ„ì¹˜

### ë°±ì—”ë“œ (ì˜ˆì •)
- **íŒŒì¼**: `fastapi/app/api/recovery.py`
- **ì´ë©”ì¼ ë°œì†¡**: `fastapi/app/utils/email_service.py` (ìŠµê´€ì•±ìš© ìˆ˜ì •)

### ë°ì´í„°ë² ì´ìŠ¤
- **í…Œì´ë¸”**: `email_verifications` (habit_app_db)
- **ì»¬ëŸ¼**: device_uuid, email, code_hash, expires_at, attempt_count, created_at

### ì°¸ê³  ë¬¸ì„œ
- [habit_app_db_schema_master_v_1_0.md](../habit/habit_app_db_schema_master_v_1_0.md)
- [master_habit_app_spec_v_1_0.md](../habit/master_habit_app_spec_v_1_0.md)

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2026-02-15
