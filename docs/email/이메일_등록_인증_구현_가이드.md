# 이메일 등록 인증 구현 가이드

습관 앱 백업/복구 기능에서 이메일 등록 시 6자리 인증 코드를 사용하는 구현 방법을 안내합니다.

**대상**: Habit App (Local-first + Snapshot Backup)  
**갱신일**: 2026-02-15

---

## 목차

1. [개요](#1-개요)
2. [데이터베이스 설정](#2-데이터베이스-설정)
3. [백엔드 구현](#3-백엔드-구현)
4. [프론트엔드 구현](#4-프론트엔드-구현)
5. [이메일 서비스 설정](#5-이메일-서비스-설정)
6. [권장 구현 순서](#6-권장-구현-순서)
7. [보안 고려사항](#7-보안-고려사항)

---

## 1. 개요

### 목적
- 이메일은 **백업/복구 수단**으로만 사용
- 로그인 없음, 계정 시스템 없음
- 백업 기능 최초 사용 시 이메일 등록 요구

### 플로우
1. **이메일 등록 요청** → 이메일 입력 후 6자리 코드 발송
2. **인증 코드 검증** → 코드 입력 후 device_uuid ↔ email 연결
3. **연결 완료** → 백업/복구 기능 사용 가능

---

## 2. 데이터베이스 설정

### 2.1 habit_app_db 스키마

`docs/habit/habit_app_db_schema_master_v_1_0.md` 참고. `email_verifications` 테이블 포함:

```sql
CREATE TABLE email_verifications (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  device_uuid CHAR(36) NOT NULL,
  email VARCHAR(255) NOT NULL,
  code_hash CHAR(64) NOT NULL,
  expires_at DATETIME NOT NULL,
  attempt_count INT NOT NULL DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_email(email),
  FOREIGN KEY (device_uuid) REFERENCES devices(device_uuid) ON DELETE CASCADE
);
```

### 2.2 devices 테이블
- `email`, `email_verified_at` 컬럼에 인증 완료 후 값 저장

---

## 3. 백엔드 구현

### 3.1 API 엔드포인트

**파일**: `fastapi/app/api/recovery.py`

#### 3.1.1 이메일 등록 요청 (코드 발송)

```python
@router.post("/email/request")
async def request_email_verification(body: EmailRequestSchema):
    """
    이메일 등록 요청
    - 6자리 코드 생성
    - code_hash 저장 (SHA256)
    - 이메일 발송
    """
    # 1. devices에 device_uuid 등록 (없으면 INSERT)
    # 2. 6자리 코드 생성: random.randint(100000, 999999)
    # 3. code_hash = hashlib.sha256(code.encode()).hexdigest()
    # 4. email_verifications에 INSERT (기존 레코드 있으면 교체)
    # 5. EmailService.send_verification_code(to_email, code)
    # 6. 성공 응답
```

**요청 body**: `{ "device_uuid": "...", "email": "user@example.com" }`

#### 3.1.2 인증 코드 검증

```python
@router.post("/email/verify")
async def verify_email_code(body: EmailVerifySchema):
    """
    인증 코드 검증
    - code_hash 비교
    - devices.email, email_verified_at 업데이트
    """
    # 1. (device_uuid, email)로 email_verifications 조회
    # 2. expires_at 확인
    # 3. attempt_count >= 5 시 실패
    # 4. sha256(code) == code_hash 비교
    # 5. attempt_count 증가 (실패 시)
    # 6. 성공 시: devices 업데이트, email_verifications 삭제
```

**요청 body**: `{ "device_uuid": "...", "email": "...", "code": "123456" }`

### 3.2 이메일 서비스 수정

`fastapi/app/utils/email_service.py`에 습관앱용 메서드 추가:

```python
@classmethod
def send_verification_code(cls, to_email: str, code: str, expires_minutes: int = 10) -> bool:
    """
    이메일 등록 인증 코드 발송 (백업/복구 수단)
    """
    subject = '[Habit App] 이메일 인증 코드'
    # HTML/텍스트 본문에 code, expires_minutes 포함
```

---

## 4. 프론트엔드 구현

### 4.1 설정 > 백업 화면

1. **이메일 등록 진입**
   - "백업" 메뉴에서 "이메일 등록" 또는 "백업 설정" 클릭
   - 백업 기능 최초 사용 시 이메일 입력 요구

2. **이메일 입력 + 코드 발송**
   - 이메일 입력 필드
   - "인증 코드 발송" 버튼 → POST /v1/recovery/email/request

3. **인증 코드 입력**
   - 6자리 숫자 입력 필드
   - "인증하기" 버튼 → POST /v1/recovery/email/verify
   - 성공 시 "이메일 등록 완료" 안내

### 4.2 구현 플로우

```
설정 > 백업
  ↓
"이메일 등록" 클릭
  ↓
이메일 입력 → "인증 코드 발송" 클릭
  ↓
POST /v1/recovery/email/request
  ↓
6자리 코드 입력 화면 표시
  ↓
코드 입력 → "인증하기" 클릭
  ↓
POST /v1/recovery/email/verify
  ↓
성공 시 백업/복구 기능 사용 가능
```

---

## 5. 이메일 서비스 설정

상세 설정은 다음 문서를 참조하세요:

- **[이메일 서비스 설정 가이드](./이메일_서비스_설정_가이드.md)**
  - Gmail 앱 비밀번호 생성 방법
  - .env 파일 설정 (SMTP_HOST, SMTP_USER, SMTP_PASSWORD 등)
  - FROM_NAME: "Habit App"

---

## 6. 권장 구현 순서

1. **MySQL habit_app_db 스키마 생성** (devices, email_verifications, backups)
2. **이메일 서비스 설정** (.env, email_service.py 수정)
3. **백엔드 API 구현**
   - POST /v1/recovery/email/request
   - POST /v1/recovery/email/verify
4. **프론트엔드 UI 구현**
   - 설정 > 백업 > 이메일 등록 화면
5. **테스트 및 검증**

---

## 7. 보안 고려사항

1. **인증 코드 만료**: 10분 (expires_at)
2. **시도 제한**: attempt_count 5회 초과 시 무효화
3. **code_hash 저장**: 평문 저장 금지, SHA256 해시만 저장
4. **이메일 발송 제한**: 동일 (device_uuid, email)로 1시간에 3회 제한 권장
5. **개인정보 고지**: 백업 진입 시 이메일 수집 목적/범위 고지 (iOS 필수)

---

## 참고 문서

- [인증_토큰과_인증코드_설명.md](./인증_토큰과_인증코드_설명.md) - 6자리 코드, code_hash 상세
- [habit_app_db_schema_master_v_1_0.md](../habit/habit_app_db_schema_master_v_1_0.md)
- [master_habit_app_spec_v_1_0.md](../habit/master_habit_app_spec_v_1_0.md)

---

**마지막 업데이트**: 2026-02-15
