# 비밀번호 변경 이메일 인증 구현 가이드

본 문서는 비밀번호 변경 시 이메일 인증을 추가하는 방법을 안내합니다.

**작성일**: 2026-01-15  
**작성자**: 김택권

---

## 목차

1. [개요](#1-개요)
2. [데이터베이스 설정](#2-데이터베이스-설정)
3. [백엔드 구현](#3-백엔드-구현)
4. [프론트엔드 구현](#4-프론트엔드-구현)
5. [이메일 서비스 설정](#5-이메일-서비스-설정)
6. [구현 방법 선택](#6-구현-방법-선택)

---

## 1. 개요

### 현재 문제점
- 비밀번호 변경 시 별도 인증 없이 바로 변경 가능
- 보안 취약점 존재

### 해결 방안
비밀번호 변경 시 다음 단계를 거치도록 구현:

1. **비밀번호 변경 요청** → 이메일로 인증 코드/링크 발송
2. **이메일 인증** → 인증 코드 입력 또는 링크 클릭
3. **인증 완료** → 비밀번호 변경 가능

---

## 2. 데이터베이스 설정

### 2.1 인증 토큰 테이블 생성

`fastapi/mysql/add_password_reset_auth_table.sql` 파일을 실행하세요:

```bash
mysql -h cheng80.myqnapcloud.com -P 13306 -u team0101 -p table_now_db < fastapi/mysql/add_password_reset_auth_table.sql
```

또는 Python으로 실행:

```python
# fastapi 폴더에서 실행
python3 -c "
import pymysql
from app.database.connection import DB_CONFIG

conn = pymysql.connect(**DB_CONFIG)
cursor = conn.cursor()

with open('mysql/add_password_reset_auth_table.sql', 'r', encoding='utf-8') as f:
    sql = f.read()

sql = sql.replace('USE \`table_now_db\`;', '').strip()

for query in sql.split(';'):
    query = query.strip()
    if query and not query.startswith('--'):
        try:
            cursor.execute(query)
            print(f'✓ 실행 완료')
        except Exception as e:
            if 'Duplicate' not in str(e):
                print(f'✗ 오류: {e}')

conn.commit()
cursor.close()
conn.close()
"
```

### 2.2 테이블 구조

```sql
password_reset_auth
- auth_seq (PK, AUTO_INCREMENT)
- customer_seq (FK → customer)
- auth_token (VARCHAR(255)) - 인증 토큰 (UUID)
- auth_code (VARCHAR(6)) - 인증 코드 (6자리 숫자, 선택사항)
- expires_at (DATETIME) - 만료 일시
- is_verified (BOOLEAN) - 인증 완료 여부
- created_at (DATETIME)
```

---

## 3. 백엔드 구현

### 3.1 필요한 패키지 추가

`fastapi/requirements.txt`에 추가:

```txt
# 이메일 발송
aiosmtplib>=3.0.0  # 비동기 SMTP (선택사항)
# 또는
# smtplib는 Python 표준 라이브러리이므로 추가 불필요
```

### 3.2 이메일 서비스 설정

`fastapi/app/utils/email_service.py` 파일이 생성되었습니다.

**환경변수 설정** (`.env` 파일 또는 환경변수):

```bash
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password  # Gmail 앱 비밀번호
FROM_EMAIL=noreply@tablenow.com
FROM_NAME=Table Now
```

**상세한 이메일 서비스 설정 방법은 다음 문서를 참조하세요:**
- [이메일 서비스 설정 가이드](./이메일_서비스_설정_가이드.md)

### 3.3 API 엔드포인트 추가

`fastapi/app/api/customer.py`에 다음 엔드포인트 추가:

#### 3.3.1 비밀번호 변경 요청 (이메일 발송)

```python
@router.post("/request-password-change")
async def request_password_change(
    customer_seq: int = Form(...)
):
    """
    비밀번호 변경 요청
    - 이메일로 인증 코드 발송
    - 인증 토큰 생성 및 저장
    """
    # 1. 고객 정보 확인
    # 2. 인증 토큰 생성 (UUID)
    # 3. 인증 코드 생성 (6자리 숫자)
    # 4. 만료 시간 설정 (10분)
    # 5. 데이터베이스에 저장
    # 6. 이메일 발송
    # 7. 성공 응답 반환
```

#### 3.3.2 인증 코드 검증

```python
@router.post("/verify-password-change-code")
async def verify_password_change_code(
    customer_seq: int = Form(...),
    auth_code: str = Form(...)
):
    """
    인증 코드 검증
    - 인증 코드 확인
    - 만료 시간 확인
    - 인증 완료 처리
    """
    # 1. 인증 토큰 조회
    # 2. 인증 코드 확인
    # 3. 만료 시간 확인
    # 4. 인증 완료 처리 (is_verified = TRUE)
    # 5. 성공 응답 반환
```

#### 3.3.3 비밀번호 변경 (인증 완료 후)

```python
@router.put("/change-password")
async def change_password(
    customer_seq: int = Form(...),
    new_password: str = Form(...),
    auth_token: str = Form(...)
):
    """
    비밀번호 변경 (인증 완료 후)
    - 인증 토큰 검증
    - 인증 완료 여부 확인
    - 비밀번호 변경
    """
    # 1. 인증 토큰 조회 및 검증
    # 2. is_verified 확인
    # 3. 만료 시간 확인
    # 4. 비밀번호 변경
    # 5. 인증 토큰 삭제 또는 무효화
    # 6. 성공 응답 반환
```

### 3.4 기존 비밀번호 변경 로직 수정

`update_customer` 함수에서 비밀번호 변경 부분을 제거하고, 별도 엔드포인트로 분리:

```python
# update_customer에서는 비밀번호 변경 불가
# 비밀번호 변경은 change_password 엔드포인트 사용
```

---

## 4. 프론트엔드 구현

### 4.1 회원 정보 수정 화면 수정

`lib/view/auth/profile_edit_screen.dart` 수정:

1. **비밀번호 변경 버튼 추가**
   - "비밀번호 변경" 버튼 클릭
   - 이메일 인증 요청 API 호출
   - 인증 코드 입력 화면으로 전환

2. **인증 코드 입력 화면**
   - 6자리 숫자 입력 필드
   - 인증 코드 검증 API 호출
   - 성공 시 비밀번호 변경 화면으로 전환

3. **비밀번호 변경 화면**
   - 새 비밀번호 입력
   - 비밀번호 확인 입력
   - 비밀번호 변경 API 호출

### 4.2 구현 플로우

```
회원 정보 수정 화면
  ↓
"비밀번호 변경" 버튼 클릭
  ↓
이메일 인증 요청 API 호출
  ↓
인증 코드 입력 화면 표시
  ↓
인증 코드 입력 및 검증 API 호출
  ↓
인증 성공 시 비밀번호 변경 화면 표시
  ↓
새 비밀번호 입력 및 변경 API 호출
  ↓
완료
```

---

## 5. 이메일 서비스 설정

이메일 서비스 설정에 대한 상세한 내용은 다음 문서를 참조하세요:

- **[이메일 서비스 설정 가이드](./이메일_서비스_설정_가이드.md)**
  - Gmail 앱 비밀번호 생성 방법
  - .env 파일 설정 방법
  - 다른 이메일 서비스 사용 방법
  - 문제 해결 방법

---

## 6. 구현 방법 선택

### 방법 1: 인증 코드 방식 (권장)

**장점:**
- 구현이 간단함
- 모바일 앱에서도 사용하기 쉬움
- 링크 클릭 불필요

**단점:**
- 사용자가 코드를 직접 입력해야 함

**구현:**
- 6자리 숫자 코드 생성
- 이메일로 코드 발송
- 사용자가 코드 입력
- 코드 검증 후 비밀번호 변경

### 방법 2: 인증 링크 방식

**장점:**
- 사용자가 링크만 클릭하면 됨
- 웹 앱에 적합

**단점:**
- 모바일 앱에서 링크 처리 복잡
- 딥링크 설정 필요

**구현:**
- 인증 토큰 생성 (UUID)
- 이메일로 링크 발송
- 링크 클릭 시 앱으로 리다이렉트
- 토큰 검증 후 비밀번호 변경

### 방법 3: 하이브리드 방식

**장점:**
- 코드와 링크 모두 제공
- 사용자 선택 가능

**단점:**
- 구현이 복잡함

---

## 7. 권장 구현 순서

1. **데이터베이스 테이블 생성**
2. **이메일 서비스 설정 및 테스트**
3. **백엔드 API 구현**
   - 비밀번호 변경 요청 API
   - 인증 코드 검증 API
   - 비밀번호 변경 API
4. **프론트엔드 UI 구현**
   - 인증 코드 입력 화면
   - 비밀번호 변경 화면
5. **테스트 및 검증**

---

## 8. 보안 고려사항

1. **인증 코드 만료 시간**: 10분 권장
2. **인증 시도 제한**: 5회 실패 시 토큰 무효화
3. **인증 토큰 일회용**: 사용 후 즉시 삭제
4. **이메일 발송 제한**: 동일 이메일로 1시간에 3회 제한
5. **비밀번호 해시화**: bcrypt 등 사용 (향후 구현)

---

## 변경 이력

- **2026-01-15**: 초기 문서 작성 (작성자: 김택권)
  - 비밀번호 변경 이메일 인증 구조 설계
  - 데이터베이스 스키마 설계
  - 백엔드/프론트엔드 구현 가이드 작성

- **2026-01-15**: 문서 정리 (작성자: 김택권)
  - 이메일 서비스 설정 중복 내용 제거
  - 상세 설정은 [이메일 서비스 설정 가이드](./이메일_서비스_설정_가이드.md) 참조하도록 변경
